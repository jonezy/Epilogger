@using Epilogger.Web;

@model Epilogger.Web.Models.EventDisplayViewModel
@{
    Layout = "~/Views/Shared/_InteriorLayout.cshtml";
    ViewBag.Title = "Epilogger - " + Model.Name;    
}

@{
    bool IncludeDateRange = false;
    int YesCount = 0;

    if (Request.QueryString["f"] != null)
    {
        YesCount++;
    }
    if (Request.QueryString["t"] != null)
    {
        YesCount++;
    }
    if (YesCount == 2)
    {
        IncludeDateRange = true;
    }
}

<script type="text/javascript" language="javascript">
    head.js('@Url.Content("~/Public/js/EventDetails.js")');
</script>

@if (Model.Tweets.FirstOrDefault() != null)
{
    <script language="javascript" type="text/javascript">
        var pageLoadTime = '@string.Format("{0:yyyy-MM-dd HH:mm:ss}", Model.Tweets.FirstOrDefault().CreatedDate)';
    </script>
}
else
{
    <script language="javascript" type="text/javascript">
        var pageLoadTime = '@string.Format("{0:yyyy-MM-dd HH:mm:ss}", DateTime.UtcNow)';
    </script>
}
<script language="javascript" type="text/javascript">
    var EventID = @Model.ID;

    var EventName = '@Model.Name';
    var EventURL = 'http://www.epilogger.com/Events/Details/@Model.ID';
    var HasSubscribed = @Model.HasSubscribed.ToString().ToLower();
    
    var disableAutoupdate = false;

    //Parameters to control the Tweet list
    var updateTimeout = 5000;
    var updateRate = 10000;
    var prologuePostsUpdates = 1;
    var isFirstFrontPage = 1;   
    var postsOnPage = new Array;
    var postsOnPageQS = '';
    var maxItemsOnPage = 6;

    //Parameters to control the Image List
    var photoUpdateTimeout = 5000;
    var photoUpdateRate = 15000;
    var photoProloguePostsUpdates = 1;
    var photoIsFirstFrontPage = 1;
    var photoPageLoadTime = pageLoadTime;
    
    var photoPostsOnPage = new Array;
    var photoPostsOnPageQS = '';
    var photoMaxItemsOnPage = 9;
    
</script>
<style type="text/css">
    .tweet {
        display: block;
        clear: both;
        position: relative;
        z-index: 1000;
    }
    
    .newupdates {
        display: none;
        background: #eebad1;
    }
</style>


<div class="grid_12 alpha">
    @if (Model.HasSubscribed)
    {
        <div class="subscribedIndicator">SUBSCRIBED</div>
    }
    
    <div class="grid_12 alpha">
        <h1>@Model.Name</h1>
        <h2 style="margin:0; padding:0">@Model.SubTitle</h2>

        @*Event Rating Section*@
        @if (!Model.HasUserRated)
        {
            <ul class="star-rating">
                @if (Model.EventRatings.Sum(i => i.UserRating) > 0)
                {
                    <li class="current-rating" style="width:@(((Convert.ToDecimal(Model.EventRatings.Sum(i => i.UserRating)) / Convert.ToDecimal(Model.EventRatings.Count())) / 5) * 100)%;" title="@((Model.EventRatings.Sum(i => i.UserRating) / Model.EventRatings.Count())) out of 5 stars - based on @Model.EventRatings.Count() ratings">
                        @((Model.EventRatings.Sum(i => i.UserRating) / Model.EventRatings.Count())) out of 5 stars
                    </li>
                }
                    else
                {
                    <li class="current-rating noratings" style="width:0%;" title="No ratings">
                        No ratings
                    </li>
                }
            </ul>
            <a href="" class="smallRateLink">(Rate this event)</a>
            using (Html.BeginForm("StarRatings", "events", FormMethod.Post, new { @id = "ratingForm" }))
            {
                @Html.Partial("_StarRatingTemplate")
                @Html.HiddenFor(model => model.ID)
                @Html.Hidden("UserRating")
            }
        }
        else
        {
            <ul class="star-rating">
                @if (Model.EventRatings.Sum(i => i.UserRating) > 0)
                {
                    <li class="current-rating" style="width:@(((Convert.ToDecimal(Model.EventRatings.Sum(i => i.UserRating)) / Convert.ToDecimal(Model.EventRatings.Count())) / 5) * 100)%;" title="@((Model.EventRatings.Sum(i => i.UserRating) / Model.EventRatings.Count())) out of 5 stars - based on @Model.EventRatings.Count() ratings">
                        @((Model.EventRatings.Sum(i => i.UserRating) / Model.EventRatings.Count())) out of 5 stars
                    </li>
                }
            </ul>
            <div class="starSmall">You rated @Model.EventRatings.Where(i => i.UserID == Model.CurrentUserID && i.EventID == Model.ID).FirstOrDefault().UserRating stars on <br /> @Html.DisplayFor(thing => Model.EventRatings.Where(i => i.UserID == Model.CurrentUserID).FirstOrDefault().RatingDateTime, "ShortDateTime")</div>
        }

        <span class="spacer"></span>    

        @*New event menu*@
        @Html.Partial("Menu", Model.ToolbarViewModel)

        <div class="spacer"></div>
    </div>
</div>


<div class="grid_5 alpha omega">
    @Html.Raw(Model.Description.Replace("\r", "<br />"))

    <span class="spacer"></span>
    
    <table id="event-particulars">
    <tr>
        <td>
            @if (Model.Venue != null)
            {
                <span class="fleft"><img src="../images/icons/checkin.png" /></span>
                <span class="fleft">@Model.Venue.Name,<br/> @Model.Venue.Address,<br /> @Model.Venue.City (<a href="http://maps.google.com/?q=@Model.Venue.Name @Model.Venue.Address @Model.Venue.City @Model.Venue.State @Model.Venue.Zip" target="_blank">map</a>)</span>
            }
       </td>
       <td>
            <span class="fleft"><img src="../images/icons/time.png" /></span>
            <span class="fleft">
            @if (Model.StartDateTime.Subtract(Model.EndDateTime).Days == 0)
            {
                @Html.DisplayFor(e => e.StartDateTime, "FullDate") <br />
                @Html.DisplayFor(e => e.StartDateTime, "Time") @:to @Html.DisplayFor(e => e.EndDateTime, "Time")
            }
            else
            {
                @Html.DisplayFor(e => e.StartDateTime) @:to @Html.DisplayFor(e => e.EndDateTime)
            }
            </span>
       </td>
    </tr>
    <tr>
        <td>
            <span class="fleft"><img src="../images/icons/cost.png" /></span>
            <span class="fleft">
            @if (Model.Cost != null)
            {
                @Model.Cost
            }
            else
            {
                @:N/A
            }
            </span>
        </td>
        <td>
            <span class="fleft"><img src="../images/icons/hashtag.png" /></span>
            <span class="fleft">
            @{
                try
                {
                    string[] SearchT = Model.SearchTerms.Split(new string[] { " OR " }, StringSplitOptions.None);
                    string SearchTerms = "";

                    foreach (string s in SearchT)
                    {
                        SearchTerms += s + ", ";
                    }
        
                    @Html.Raw(SearchTerms.Substring(0, (SearchTerms.Length - 2)))
                }
                
                catch
                {
                <strong>@Model.SearchTerms</strong>
                }
            }
            </span> 
        </td>
    </tr>
    </table>
</div>

<div class="grid_7 alpha omega">
    MAP
</div>

@*

<div class="grid_12 alpha">
    @if (Model.HasSubscribed)
    {
        <div class="subscribedIndicator">
            SUBSCRIBED</div>
    }
    <div class="grid_10 alpha">
        <h1>@Model.Name</h1>
        <h2><span style="float:left">@Model.SubTitle</span></h2>
        <br class="clear" />

        
        

        <div id="event-intro">
            @Html.Raw(Model.Description.Replace("\r", "<br />"))
        </div>

        <div class="sm-spacer"></div>
    </div>
</div>

<div class="sm-spacer"></div>

    <!--
    <div class="inEventSearch fleft">
        @using (Html.BeginForm("Search", "events", FormMethod.Post, null))
        {
            @Html.TextBox("SearchTerm")
            <input type="submit" class="blue-action-button remove-bottom" value="Search" />
            @Html.HiddenFor(model => model.ID)
        }
    </div>
    -->
    @if (Model.HasSubscribed)
        {
            using (Html.BeginForm("unsubscribe", "events", FormMethod.Post, new { @class = "remove-bottom" }))
            {
            <input type="submit" value="Unsubscribe" name="SubscribeToEvent" class="fleft blue-action-button remove-bottom" id="" />
            @Html.HiddenFor(model => model.ID)
            }
        }
        else
        {
            using (Html.BeginForm("subscribe", "events", FormMethod.Post, new { @class = "remove-bottom" }))
            {
            <input type="submit" value="Subscribe" name="SubscribeToEvent" class="fleft blue-action-button remove-bottom" id="" />
            @Html.HiddenFor(model => model.ID)
            }
        }

    <div class="filter-by-time fright">
        @using (Html.BeginForm("details", "events", new { id = Model.ID }, FormMethod.Post, null))
        {
            @Html.Hidden("ResetDates")
            <h4>Filter timespan:&nbsp; </h4>
            @Html.EditorFor(m => m.FromDateTime)
            <label style="position:relative; left:-10px">to</label>
            @Html.EditorFor(m => m.ToDateTime)
            <input type="submit" value="ok" class="blue-action-button" /> 
            <input type="button" value="x" name="ClearDates" onclick="$('#ResetDates').val('1'); $(form).submit();" />
        }
    </div>

<br class="clear" />
<div class="sm-spacer"></div>*@

@*
<div id="event-details" class="clearfix">
    <ul>
        <li>
            <label>When:</label><div class="value">
            <div class="value">
                    @if (Model.StartDateTime.Subtract(Model.EndDateTime).Days == 0)
                    {
                        @Html.DisplayFor(e => e.StartDateTime, "FullDate") <br />
                        @Html.DisplayFor(e => e.StartDateTime, "Time") @:to @Html.DisplayFor(e => e.EndDateTime, "Time")
                    }
                    else
                    {
                        @Html.DisplayFor(e => e.StartDateTime) @: to <br />
                        @Html.DisplayFor(e => e.EndDateTime)
                    }
                </div>
        </li>
    </ul>

    <ul>
        <li>
            <label>Where:</label>
            <div class="value">
                @if (Model.Venue != null)
                {
                    <dd>@Model.Venue.Name<br/> @Model.Venue.Address, @Model.Venue.City<br/> (<a href="http://maps.google.com/?q=@Model.Venue.Name @Model.Venue.Address @Model.Venue.City @Model.Venue.State @Model.Venue.Zip" target="_blank">see map</a>)</dd>
                }
            </div>
        </li>
    </ul>

    <ul class="hashtags">
        <li>
            <label> Hashtag(s):</label>
            <div class="value">
                    @{
                        try
                        {
                            string[] SearchT = Model.SearchTerms.Split(new string[] { " OR " }, StringSplitOptions.None);
                            string SearchTerms = "";

                            foreach (string s in SearchT)
                            {
                                SearchTerms += s + ", ";
                            }
        
                        @Html.Raw("<strong>" + SearchTerms.Substring(0, (SearchTerms.Length - 2)) + "</strong>")
                        }
                        catch
                        {
                        <strong>@Model.SearchTerms</strong>
                        }
                    }
            </div>
        </li>
    </ul>

    <ul>
        <li>
            <label>Cost:</label>
            <div class="value">
                    @if (Model.Cost != null)
                    {
                        @Model.Cost
                    }
                    else
                    {
                        @:N/A
                    }
            </div>
        </li>
        <li>
            <label>Url:</label>
            <div class="value"><a href="@Model.WebsiteURL" target="_blank">@Model.WebsiteURL</a></div>
        </li>
        <li>
            <label></label>
            <div class="value">
                @if (Model.TwitterAccount != null)
                {
                    @:<span class="label">tw:</span> <a href="http://www.twitter.com/@Model.TwitterAccount">@Model.TwitterAccount</a>
                            }
                @if (Model.FacebookPageURL != null)
                {
                    @:<br/><span class="label">fb:</span> <a href="@Model.FacebookPageURL" target="_blank">visit page</a><br/>
                            }
            </div>
        </li>
    </ul>
</div>*@

<div class="spacer clear"></div>


<!-- TWEETS -->
<div class="grid_5 alpha omega">
    <h2>
        <span class="number" id="tweetCount">@string.Format("{0:#,###}", Model.TweetCount)</span>Tweets
        & Shoutouts</h2>
    <span class="sm-spacer"></span>
    <ul class="plain-list" id="tweetlist">
        @foreach (Epilogger.Data.Tweet EPLTweet in Model.Tweets)
        {
            @Html.Partial("_TweetTemplate", EPLTweet);
        }
    </ul>

    
     <p>(@Html.ActionLink("See all tweets", "allTweets", "events", new { id = Model.ID, f = Request.QueryString["f"], t = Request.QueryString["t"] }, new { }))</p>
                   
    <span class="sm-spacer"></span>
</div>


<!-- PHOTOS & VIDEOS -->
<div class="grid_7 omega">
    <h2>
        <span class="number" id="photoCount">@string.Format("{0:#,###}", Model.ImageCount)</span>Photos
        & Videos
    </h2>
    <div class="image-grid" id="photosvideos">
        @foreach (Epilogger.Data.Image EPLImage in Model.Images)
        {
            @Html.Partial("_ImageTemplate", EPLImage)
        }
    </div>

    <span class="clear sm-spacer"></span>

    <p>
        @if (!IncludeDateRange)
        { 
            @: (@Html.ActionLink("See all photos and videos", "AllPhotos", "events", new { id = Model.ID }))
           }
        else
        { 
            @: (@Html.ActionLink("See all photos and videos", "AllPhotos", "events", new { id = Model.ID, f = Request.QueryString["f"], t = Request.QueryString["t"] }, new { }))
        }
    </p>
</div>

<div class="clear spacer"></div>

<div class="event-bottom">
    <!-- BLOG POSTINGS -->
    <div class="grid_4 alpha">
        <h2>
            Blog postings</h2>
        <ul class="plain-list">
            @foreach (Epilogger.Data.BlogPost TheBlogPost in Model.BlogPosts.Take(3))
            {
                <li class="blogpost">
                    
                    <a href="@TheBlogPost.BlogURL">@TheBlogPost.Title</a><br />
                    <p class="blogDescription">
                        @TheBlogPost.Description<br />
                        <span class="blogPostDate">@Html.DisplayFor(e => TheBlogPost.DateTime)</span>
                    </p>
                </li>
                    @*<img src="@Url.Content("~/Public/images/samples/avatar.png")" class="fleft"/>*@
                    @*<small><a href="#">BY MICHAEL NUS</a></small><br />*@
                    @*<p>After a very busy day of meetings and wheeling...</p>*@
                    @*TODO - Add move fiels to the Blog table to store more Info!*@ 
            }
        </ul>
        <div class="clear">
        </div>
        <p>
             (@Html.ActionLink("See all blog posts", "allblogposts", "events", new { id = Model.ID, f = Request.QueryString["f"], t = Request.QueryString["t"] }, new { })) (<a href="#" class="blogposts-modal">Submit blog post</a>)</p>
    </div>
    <!-- EXTERNAL LINKS -->
    <div class="grid_4 overflowhide">
        <h2>External Links</h2>
        <ul class="plain-list">
            @foreach (Epilogger.Data.URL TheURL in Model.ExternalLinks)
            {
                <li><a href="@TheURL.ShortURL" title="@TheURL.Tweets.Where(t => t.ID == TheURL.TweetID).FirstOrDefault().Text">@TheURL.FullURL</a><br />
                    <small>
                        <img src="@Url.Content("~/Public/images/icons/tweet-black.png")" class="valign" />VIA
                        @TheURL.Tweets.Where(t => t.ID == TheURL.TweetID).FirstOrDefault().FromUserScreenName</small>
                </li>
            }
        </ul>
        <div class="clear">
        </div>
        <p>
            @if (!IncludeDateRange)
            { 
                @: (@Html.ActionLink("See all links", "alllinks", "events", new { id = Model.ID }))
           }
            else
            { 
                @: (@Html.ActionLink("See all links", "alllinks", "events", new { id = Model.ID, f = Request.QueryString["f"], t = Request.QueryString["t"] }, new { }))
                       }

                       @*(<a href="#" class="links-modal">Submit a link</a>)*@
        </p>
    </div>
    <!-- CHECKINS -->
    <div class="grid_3 omega" style="margin-top: -20px;">
        <h2>
            <span class="number">@Model.CheckInCount</span> Check-ins</h2>
        <p>
            All these lovely people attended @Model.Name!</p>
        <div class="event-checkins clearfix">
            @foreach (Epilogger.Data.CheckIn checkin in @Model.CheckIns)
            {
                Epilogger.Data.Tweet ThisTweet = checkin.Tweets.Where(t => t.ID == checkin.TweetID).FirstOrDefault();
                <a href="@checkin.FourSquareCheckInURL" target="_blank">
                    <img src="@Url.Content(ThisTweet.ProfileImageURL)" class="fleft" height="48" width="48" alt="" /></a>
            }
        </div>
    </div>
</div>
<br style="clear: both;" />
@*<div class="grid_4 omega">
    <small class="tinylabel">Sponsors
        & Supporters</small>
    <img src="@Url.Content("~/Public/images/samples/ad.png")" alt="" />
    <img src="@Url.Content("~/Public/images/samples/ad.png")" alt="" />
</div>*@
<script>
    head.ready(function () {
        $("a[rel^='prettyPhoto']").prettyPhoto({
            theme: 'light_square',
            animation_speed: 'fast',
            overlay_gallery: false,
            changepicturecallback: function () { changeDescription(); }
        });

        $(".blogposts-modal").colorbox({
            width: "60%", height: "370px",
            href: '@Url.Action("AddBlogPost", "Events", new { id = Model.ID })',
            onComplete: function () { $("#BlogURL").focus(); }
        });


        $(".links-modal").colorbox({
            width: "60%", height: "60%",
            href: '@Url.Action("AddLink", "Events")'
        });
    });

</script>


